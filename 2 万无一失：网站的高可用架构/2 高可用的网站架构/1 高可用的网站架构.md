# 高可用的网站架构

- [高可用的网站架构](#%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84%E7%BD%91%E7%AB%99%E6%9E%B6%E6%9E%84)
    - [应用层，如果高可用？](#%E5%BA%94%E7%94%A8%E5%B1%82%EF%BC%8C%E5%A6%82%E6%9E%9C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F)
    - [服务层，如何高可用？](#%E6%9C%8D%E5%8A%A1%E5%B1%82%EF%BC%8C%E5%A6%82%E4%BD%95%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F)
    - [数据层，如何高可用？](#%E6%95%B0%E6%8D%AE%E5%B1%82%EF%BC%8C%E5%A6%82%E4%BD%95%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F)

主要手段是数据和服务的冗余备份及失效转移，一旦某些服务器宕机，就将服务切换到其他可用的服务器上。如果磁盘磁盘损坏，则从备份的磁盘读取数据。

典型大型网站的分层架构模型，见图 5.4 分层后按模块分割的网站架构模型

按照分层模型，分别阐述不同层次下的高可用方案。

## 应用层，如果高可用？

- 通过负载均衡进行无状态服务的失效转移，见图 5.5 利用负载均衡服务器实现高可用的应用服务

- 应用服务器集群的 Session 管理。单机情况下，Session 可由部署在服务器上的 Web 容器（如 JBoss）管理。但在使用负载均衡的集群环境中，由于负载均衡服务器可能会将请求分发到集群任何一台应用服务器上，所以保证每次请求依然能够获得正确的 Session 比单机时要复杂很多。集群环境下，Session 管理主要有以下几种手段：
  - Session 复制，见图 5.6 使用 Session 复制实现应用服务器共享 Session（只适合集群规模较小情况）
  - Session 绑定，见图 5.7 利用负载均衡的会话粘滞机制将请求绑定到特定服务器（少用，因不高可用）
  - 利用 Cookie 记录 Session，见图 5.8 利用 Cookie 记录 Session 信息
  - 使用 Session 服务器，见图 5.9 利用 Session 服务器共享 Session

## 服务层，如何高可用？

- 分级管理，核心应用和服务优先使用更好的硬件
- 超时设置，在应用程序中设置服务调用的超时时间，如果超时可将请求转移到提供相同服务的其他服务器上
- 异步调用，对服务的调用通过消息队列等异步方式完成
- 服务降级，1 拒绝低优先级应用的调用 2 关闭部分不重要的服务
- 幂等性设计，必须保证服务当“调用多次”和“调用一次”时所产生的结果相同，即服务具有幂等性

## 数据层，如何高可用？

- CAP 原理：一个提供数据服务的存储系统无法同时满足数据一致性（Consistency）、数据可用性（Availibility）、分区耐受性（Patition Tolerance 系统可以跨网络分区线性伸缩）这三个条件。有时候为了保证数据的可用性、分区耐受性，就必须放弃数据一致性。
  一般说来，数据不一致通常出现在系统高并发写操作或者集群状态不稳（故障恢复、集群扩容）的情况下。
  - 数据一致性的分类：
    - 数据强一致，各个副本的数据绝对一致
    - 数据用户一致，各个副本的数据可能不一致，但通过纠错和校验，可以确定一个一致且正确的数据返回给用户
    - 数据最终一致，各个副本的数据可能不一致，但经过自我恢复和修正，数据最终会达到一致

- 数据备份，保证数据有多个副本
  - 冷备份，定期将数据复制到某种存储介质上并物理存档保管
  - 热备份
    - 异步热备份，见图 5.11 数据异步备份
    - 同步热备份，见图 5.12 数据同步热备

- 失效转移，快速切换访问数据的其他副本
  失效转移操作由三部分组成：
  - 失效确认，手段有两种：1 心跳检测 2 应用程序访问失败报告，见图 5.13 存储服务器失效确认
  - 访问转移，将数据读写访问路由到其他服务器上
  - 数据恢复，数据存储的副本要恢复