# 应用服务器性能优化

- [应用服务器性能优化](#%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96)
    - [分布式缓存](#%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98)
    - [异步操作](#%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C)
    - [使用集群](#%E4%BD%BF%E7%94%A8%E9%9B%86%E7%BE%A4)
    - [代码优化](#%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96)

网站性能优化第一定律：优先考虑使用缓存优化性能。

## 分布式缓存

- 缓存的基本原理

  混存的本质是一个内存 Hash 表，数据以一对 key value 的形式缓存在内存 Hash 表中。
  缓存主要用来存放那些读写比很高、很少变化的数据。

- 合理使用缓存
  - 不要保存频繁修改的数据
  - 只存储不会频繁修改的且有热点的数据
  - 数据不一致与赃读，考虑失效时间
  - 缓存服务宕机会导致数据库压力过大。通过分布式缓存服务器集群，将数据分布到多台上，可以一定程度上改善。
  - 缓存预热，先把热点数据加载好
  - 缓存穿透，将不存在的数据也缓存起来（其value值设为null）

- 分布式缓存架构

  缓存部署在多个服务器组成的集群中，以集群方式提供缓存服务，架构方式有两种：
  - 一种是以 JBoss Cache 为代表的需要更新同步；图 4.9
  - 一种是以 Memcached 为代表的不互相通信的分布式缓存；图 5.0

- Memcached:
  - 简单的通信协议：TCP协议通信，UDP也支持
    序列化协议：基于文本的一套自定义协议，如 get
  - 丰富的客户端程序：java，c/c++/c#，perl, python, php, ruby等
  - 高性能的网络通信：Memcached 基于支持事件触发的网络通信程序库 Libevent
  - 高效的内存管理：固定空间分配。
      memcached 把内存分为一组slab，每一组slab包含一组chunk
      用LRU算法释放最近最久未被访问的数据空间
  - 互不通信的服务器集群架构：无限制的线性伸缩

## 异步操作

  消息队列的作用：1 调用异步化，可改善网站的扩展性；2 改善网站系统的性能。 图4.13

## 使用集群

  将并发访问请求分发到多台服务器上处理，避免单一服务器因负载压力过大而响应缓慢。 图4.15

## 代码优化

- 多线程

  - 为什么不使用多进程？CGI 编程时代，每个用户请求都会创建一个独立的系统进程去处理。由于线程比进程更轻量，更少占有系统资源，切换代价更小，所以目前主要的 Web 应用服务器都采用多线程的方式响应并发用户请求，因此网站开发天然就是多线程编程。

  - 使用多线程的原因：1 IO 阻塞 2 多 CPU

  - 最佳启动线程数是多少？启动线程数 = [任务执行时间/(任务执行时间-IO等待时间)] * CPU内核数
  最佳启动线程数与 CPU 内核数量成正比，和 IO 阻塞时间成反比。如果任务都是 CPU 计算型任务，那么线程数最多不超过 CPU 内核数，因为启动再多线程，CPU 也来不及调度；相反如果是任务需要等待磁盘操作，网络响应，那么多启动线程有助于提高任务并发度，提高系统吞吐能力，改善系统性能。

  - 如何处理多线程安全？
    1 将对象写成无状态对象（对象中没有成员变量）
    2 使用局部对象
    3 并发访问资源时使用锁

- 资源复用

  尽量减少开销很大的系统资源的创建和销毁：数据库连接、网络通信连接、线程、复杂对象
  - 资源复用主要有两种模式：
    - 单例模式 Singleton
    - 对象池 Object Pool：通过复用对象实例，减少对象创建和资源消耗。

- 数据结构

  在不同场景中合理使用恰当的数据结构，灵活组合各种数据结构改善数据读写和计算特性可极大优化程序的性能。

- 垃圾回收

  如果 Web 应用运行在 JVM 等具有垃圾回收功能的环境中，那么垃圾回收可能会对系统的性能特性产生巨大影响。